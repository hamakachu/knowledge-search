# Claude Code 開発ルール

このプロジェクトでClaude Codeを使用する際の必須ルールを定義します。

## あなたの役割
- あなたは、熟練したフルスタックエンジニアです。テスト駆動開発の原則に従い、安全で保守性の高いコードを書きます。

## 共通ルール
- コメント、テストメソッドのパターン名は日本語で記述する。
- 例：`testMethod_AをBするとCになる`、`// TODO 今後の実装でXXの機能を追加`

## 1. テスト駆動開発（TDD）の徹底

### 原則
- **すべての実装はテスト駆動開発（TDD）で行う**
- テストコードを先に書き、その後に実装コードを書く
- Red → Green → Refactor サイクルを遵守する

### TDDプロセス
1. **Red**: 失敗するテストを先に書く
2. **Green**: テストをパスする最小限の実装を書く
3. **Refactor**: テストをパスした状態で、コードをリファクタリングする

### テストカバレッジ
- 単体テスト（Unit Test）を必須とする
- 統合テスト（Integration Test）は必要に応じて実装
- テストカバレッジ目標: 80%以上

---

## 2. エージェント間コミュニケーション

### 原則
メインエージェントとサブエージェント間のやり取りは、**`.claude/docs/dashboard.md` を通じて行う。**

### サブエージェントの種類

#### 開発サブエージェント
- **frontend_developer**: フロントエンド実装（React + TypeScript + Tailwind CSS）
- **backend_developer**: バックエンド実装（Express + TypeScript + PostgreSQL）

#### レビューサブエージェント
- **typescript_reviewer**: TypeScriptコードのレビュー

### メインエージェントの責務
1. **サブエージェント起動前**: dashboard.mdの「メインエージェント → サブエージェント」セクションにタスク指示を記載
   - 担当サブエージェントを明記
2. **サブエージェント起動後**: dashboard.mdの「サブエージェント → メインエージェント」セクションを確認
3. **結果受領後**: 履歴に記録し、現在のタスクセクションをクリア
4. **サブエージェント間連携が必要な場合**:
   - dashboard.mdの「サブエージェント間連携」セクションを確認
   - 必要に応じて次のサブエージェントを起動

### 開発サブエージェントの責務
1. **起動時**: dashboard.mdの「メインエージェント → サブエージェント」セクションを確認
2. **TDD実装**: Red → Green → Refactor サイクルで実装
3. **作業完了後**: dashboard.mdの「サブエージェント → メインエージェント」セクションに結果を記載
4. **他のサブエージェントとの連携が必要な場合**:
   - dashboard.mdの「サブエージェント間連携」セクションに依頼内容を記載
   - メインエージェントに報告

### レビューサブエージェントの責務
1. **起動時**: dashboard.mdの「メインエージェント → サブエージェント」セクションを確認
2. **レビュー実行**: `.claude/rules/review_rule.md` に従ってレビュー
3. **作業完了後**: dashboard.mdの「サブエージェント → メインエージェント」セクションに結果を記載
4. **返答完了**: 履歴に記録

### メリット
- エージェント間のやり取りが明確に記録される
- 非同期でのコミュニケーションが可能
- フロント・バック間のタスク連携が構造化される
- トラブルシューティング時に履歴を参照できる

---

## 3. コードレビュープロセス

実装完了後は、**必ずレビュー専用サブエージェントによるレビューを実施する。**

詳細は `.claude/rules/review_rule.md` を参照すること。

---

## 4. ユーザー承認プロセス

### 必須ルール
**ユーザーの明示的な承認なしに、以下の変更を反映してはならない:**

- コードの変更（新規作成・編集・削除）
- 依存パッケージの追加・削除・更新
- 設定ファイルの変更
- データベーススキーマの変更
- デプロイ・リリース操作

### 承認フロー
1. **変更内容の提示**: 何を変更するか明確に説明
2. **テスト結果の提示**: すべてのテスト・チェックがパスしていることを確認
3. **ユーザーの承認待ち**: 明示的に承認を求める
4. **承認後に反映**: ユーザーが承認したら変更を反映

### 承認を求める際の表記例

詳細は `.claude/rules/review_rule.md` を参照すること。

---

## 5. 例外ケース

以下の操作は**承認不要**で実行可能:
- ドキュメント（README.md等）の参照・閲覧
- コードの調査・検索
- テストの実行（既存コードに対する）
- ログ・エラーメッセージの確認

---

## 6. 違反時の対処

このルールに違反した場合:
1. 即座に作業を停止
2. ユーザーに報告
3. 必要に応じてロールバック

---

## 7. 開発フロー

### パターンA: メインエージェントが直接実装する場合

| フェーズ | 担当 | 必須アクション |
|---------|------|--------------|
| **実装前** | メインエージェント | テストを先に書く（TDD） |
| **実装** | メインエージェント | テストをパスする最小実装 |
| **レビュー依頼** | メインエージェント | dashboard.mdにタスク指示を記載 |
| **レビュー** | レビューサブエージェント | `.claude/rules/review_rule.md` 参照 |
| **レビュー結果** | レビューサブエージェント | dashboard.mdに結果を記載 |
| **修正 or 承認** | メインエージェント | 問題があれば修正、なければユーザーに承認を求める |
| **反映** | メインエージェント | 承認後に変更を反映 |

### パターンB: 開発サブエージェントに実装を委任する場合

| フェーズ | 担当 | 必須アクション |
|---------|------|--------------|
| **タスク分析** | メインエージェント | フロント・バックどちらか、または両方必要か判断 |
| **実装依頼** | メインエージェント | dashboard.mdにタスク指示を記載し、開発サブエージェント起動 |
| **実装** | 開発サブエージェント | TDD（Red → Green → Refactor）で実装 |
| **連携依頼** | 開発サブエージェント | 必要な場合、dashboard.mdの「サブエージェント間連携」に記載 |
| **連携実装** | メインエージェント | 連携セクションを確認し、次のサブエージェントを起動 |
| **実装結果** | 開発サブエージェント | dashboard.mdに結果を記載 |
| **レビュー依頼** | メインエージェント | dashboard.mdにレビュー指示を記載し、レビューサブエージェント起動 |
| **レビュー** | レビューサブエージェント | `.claude/rules/review_rule.md` 参照 |
| **レビュー結果** | レビューサブエージェント | dashboard.mdに結果を記載 |
| **修正 or 承認** | メインエージェント | 問題があれば修正、なければユーザーに承認を求める |
| **履歴記録** | メインエージェント | dashboard.mdの履歴に記録し、セクションをクリア |
| **反映** | メインエージェント | 承認後に変更を反映 |

**すべての開発工程でこのルールを遵守すること。**

---

## 8. 開発ベストプラクティス

このセクションには、実際の開発を通じて得られた知見とパターンを記録します。

### 8.1 TypeScriptプロジェクト構造

詳細は `.claude/rules/typescript_project_structure.md` を参照すること。

### 8.2 外部API依存の実装パターン

詳細は `.claude/rules/external_api_mock_pattern.md` を参照すること。

### 8.3 トラブルシューティング

詳細は `.claude/rules/troubleshooting.md` を参照すること。

---

## 9. スキル化の検討

### 9.1 スキル化とは

繰り返し発生する開発パターンやタスクを、再利用可能な「スキル」として定義すること。

### 9.2 スキル化の対象

以下のような場合、スキル化を検討する:

1. **同じ指示を3回以上繰り返した場合**
   - 例: 「動作確認をしてください」→ `typecheck + lint + test` を実行

2. **定型的な作業フローがある場合**
   - 例: 「新しいAPIエンドポイントを追加」→ TDD + ルーティング + テスト

3. **複数ステップで構成される複雑な作業**
   - 例: 「データベースマイグレーション実行」→ スキーマ作成 + 適用 + 確認

### 9.3 スキル化のプロセス

1. **パターンの特定**
   - 同じ指示や作業が繰り返されているか確認

2. **要件の抽出**
   - スキルが受け取るべきパラメータを定義
   - 期待される出力を明確化

3. **スキル設計**
   - スキル名の決定
   - 実行フローの定義
   - エラーハンドリングの考慮

4. **ドキュメント化**
   - CLAUDE.mdにスキルの説明を追加
   - 使用例を記載

5. **レビューと改善**
   - 実際に使用してフィードバックを収集
   - 必要に応じて改善

### 9.4 スキル候補（今後検討）

以下は、このプロジェクトで今後スキル化を検討すべき候補:

- **品質チェックスキル**: `typecheck + lint + test` を一括実行
- **TDD実装スキル**: Red → Green → Refactor サイクルをガイド
- **データベースマイグレーションスキル**: スキーマ作成から適用まで
- **API エンドポイント追加スキル**: ルーティング + サービス + テストの雛形作成

**重要**: スキル化は必要性が明確になってから実施する。過度な抽象化は避ける。

### 9.5 利用可能なスキル

現在、以下のスキルが利用可能です:

#### skill-creator
- **目的**: 繰り返しパターンからスキル定義を自動生成
- **使用方法**:
  1. dashboard.mdの「メインエージェント → サブエージェント」セクションにタスク指示を記載
  2. Task toolで skill_creator エージェントを起動
  3. dashboard.mdで結果を確認
- **詳細**: [skills/skill_creator/SKILL.md](skills/skill_creator/SKILL.md)

**スキル追加の手順**:
1. 繰り返しパターンを3回以上確認
2. skill-creatorを使用してスキル定義を生成
3. CLAUDE.mdのこのセクションにスキル情報を追加

---

## 10. 次に行うべきアクション

### 10.1 実装完了した機能の動作確認

#### ドキュメント統計情報表示機能（データベース統合完了 - 2026-02-04）

**実装内容**:
- バックエンド: `GET /api/stats` エンドポイント
- フロントエンド: `DocumentStats` コンポーネント
- データベース統合: PostgreSQLからの実データ取得
- ステータス: ✅ 実装完了、✅ データベース統合完了、✅ レビュー完了、✅ ユーザー承認済み

**実装済み機能**:
- PostgreSQLデータベースからの統計情報取得
  - `SELECT COUNT(*) FROM documents` で総ドキュメント数を取得
  - `SELECT MAX(updated_at) FROM documents` で最終更新日時を取得
- データベースが空の場合の適切なハンドリング
  - `totalDocuments: 0`, `lastUpdated: null` を返す
- フロントエンド型定義の更新（`lastUpdated: string | null`）
- データがない場合の表示対応（"データがありません"）

**動作確認方法**:
1. **データベース起動**
   ```bash
   docker-compose up -d postgres
   ```

2. **アプリケーション起動**
   ```bash
   # バックエンド起動
   cd backend
   pnpm dev

   # 別のターミナルでフロントエンド起動
   cd frontend
   pnpm dev
   ```

3. **ブラウザで確認**
   - `http://localhost:5173` にアクセス
   - DocumentStatsコンポーネントが表示されることを確認
   - データベースにデータがある場合: 総ドキュメント数と最終更新日時が表示
   - データベースが空の場合: "データがありません" が表示

4. **APIの直接確認（オプション）**
   ```bash
   curl http://localhost:3000/api/stats
   ```

---

### 10.2 優先度の高い次期実装候補

以下は、プロジェクトの次のステップとして検討すべき機能です：

1. **Qiita Team連携（sync-worker）**
   - 記事同期機能の実装
   - スケジュール実行
   - 初回データ投入

2. **検索機能の実装**
   - 全文検索API実装（`pg_trgm` 使用）
   - 検索ボックスコンポーネント
   - 検索結果リストコンポーネント

3. **検索機能の拡張**
   - フィルタリング機能（ソース別、日付範囲等）
   - ソート機能（関連度、更新日時等）
   - ページネーション

4. **ユーザー認証**
   - ログイン機能
   - 認証トークン管理

**実装時の注意**:
- すべての新機能は TDD で実装すること
- 開発サブエージェント（frontend_developer、backend_developer）を活用すること
- dashboard.mdを通じてエージェント間連携を行うこと
- 実装完了後は必ず typescript_reviewer によるレビューを実施すること

---

## 11. まとめ

このプロジェクトでは、以下の原則に従って開発を進める:

1. **TDD徹底**: Red → Green → Refactor
2. **エージェント間コミュニケーション**: `.claude/docs/dashboard.md` を使用
3. **開発サブエージェント**: フロント（`frontend_developer`）・バック（`backend_developer`）で実装を分担
4. **レビュー**: `.claude/rules/review_rule.md` 参照
5. **TypeScriptプロジェクト構造**: `.claude/rules/typescript_project_structure.md` 参照
6. **外部API**: `.claude/rules/external_api_mock_pattern.md` 参照
7. **トラブルシューティング**: `.claude/rules/troubleshooting.md` 参照
8. **スキル化**: 繰り返しパターンは精査の上、スキル化を検討

### 利用可能なサブエージェント

| サブエージェント | 役割 | 技術スタック |
|-----------------|------|-------------|
| **frontend_developer** | フロントエンド実装 | React + TypeScript + Tailwind CSS |
| **backend_developer** | バックエンド実装 | Express + TypeScript + PostgreSQL |
| **typescript_reviewer** | コードレビュー | TypeScript品質チェック |
| **skill_creator** | スキル定義の生成・管理 | スキル化フレームワーク |

**すべての開発工程でこのルールを遵守すること。**
