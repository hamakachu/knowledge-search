# plan_and_commit スキル

## 概要

`plan_and_commit` は、実装前に詳細な実装計画を立て、プランファイルを `.claude/docs/` 配下にコミットするワークフローを標準化するスキルです。

## なぜこのスキルが必要か

### 解決する課題
- **実装前の計画不足**: 複雑なタスクに着手する前に、十分な計画が立てられていない
- **コードベースの把握不足**: 既存の実装パターンやアーキテクチャを理解せずに実装を始めてしまう
- **認識齟齬**: ユーザーとの認識が合わないまま実装を進めてしまう
- **ドキュメント不足**: 実装計画がドキュメント化されず、後から経緯を追えない

### メリット
- ✅ **事前の設計レビュー**: 実装前にユーザーと計画を共有し、承認を得られる
- ✅ **効率的な実装**: TDD実装フローが明確化され、迷わず実装を進められる
- ✅ **品質向上**: エラーハンドリングや検証手順が事前に設計される
- ✅ **ドキュメント化**: 実装計画がGitで管理され、チーム全体で共有可能

## クイックスタート

### 基本的な使い方

```
/plan_and_commit task_description="実装するタスクの概要"
```

例:
```
/plan_and_commit task_description="Qiita Team sync-workerのDB upsert処理実装"
```

### 実行フロー

1. **Plan Mode起動** → Exploreエージェント、Planエージェントが使用可能に
2. **コードベース調査** → Exploreエージェントが既存コードを調査
3. **実装設計** → Planエージェントが詳細な計画を作成
4. **Plan File作成** → `~/.claude/plans/` 配下に保存
5. **ユーザーレビュー** → ユーザーが計画を確認
6. **コピー & コミット** → `.claude/docs/` 配下にコピーし、Gitコミット

## 使用例

### 例1: DB upsert処理の実装計画

```
/plan_and_commit task_description="Qiita Team sync-workerのDB upsert処理実装"
```

**作成される実装計画書の内容**:
- 概要（目的、実装箇所、技術要件）
- 実装アプローチ（Repository パターンの採用理由）
- 実装の詳細（型定義、メソッド、SQL、トランザクション処理）
- TDD実装フロー（5つのPhase）
- エラーハンドリング（4種類のエラー対策）
- 実装の優先順位（優先度1-3）
- Critical Files（最も重要な3ファイル）
- Verification（8つの検証手順）

### 例2: カスタムファイル名を指定

```
/plan_and_commit task_description="ユーザー認証機能の追加" plan_filename="user-auth-plan.md"
```

### 例3: Exploreフェーズをスキップ（簡易タスク）

```
/plan_and_commit task_description="簡易なバグ修正" skip_explore=true
```

## 実装計画書のテンプレート

実装計画書には、以下のセクションが含まれます:

1. **概要**: 目的、実装箇所、技術要件
2. **実装アプローチ**: アーキテクチャパターンとファイル構成
3. **実装の詳細**: 型定義、メソッド、SQL、トランザクション処理
4. **TDD実装フロー**: Red → Green → Refactor のPhase分け
5. **エラーハンドリング**: 想定エラーと対策
6. **実装の優先順位**: 優先度1（必須）、優先度2（推奨）、優先度3（将来的）
7. **Critical Files**: 最も重要なファイル
8. **Verification**: テスト、Lint、型チェック、ビルド、手動確認
9. **コミットメッセージ（参考）**
10. **まとめ**

## Plan Modeの使用タイミング

### Plan Modeを使用すべき場合（✅）
- 複雑な実装タスク（複数のファイルを変更）
- 既存コードベースの把握が必要
- チームレビューが必要
- 実装の優先順位付けが必要

### Plan Modeを使用しない場合（❌）
- 単純なタスク（1ファイルの簡単な修正）
- 緊急のバグ修正
- ドキュメントのみの更新

## パラメータ

| パラメータ名 | 必須/任意 | デフォルト値 | 説明 |
|------------|---------|-------------|------|
| task_description | 必須 | - | 実装するタスクの概要 |
| plan_filename | 任意 | task名から自動生成 | 計画書のファイル名 |
| skip_explore | 任意 | false | Exploreフェーズをスキップ |

## ワークフロー図

```
┌─────────────────────────────────────────────────┐
│ 1. Plan Mode起動（EnterPlanMode）                │
└─────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│ 2. コードベース調査（Explore Agent）             │
└─────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│ 3. 実装設計（Plan Agent）                        │
└─────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│ 4. Plan File作成                                 │
│    ~/.claude/plans/[random-name].md             │
└─────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│ 5. ユーザーレビュー待機                          │
└─────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│ 6. コピー & コミット                             │
│    .claude/docs/[descriptive_name]_plan.md      │
└─────────────────────────────────────────────────┘
```

## トラブルシューティング

| エラーケース | 対処方法 |
|-------------|---------|
| Plan Modeが起動しない | `EnterPlanMode` ツールが利用可能か確認 |
| Exploreエージェントが情報を見つけられない | skip_explore=trueで再試行 |
| ユーザーがレビューで修正を要求 | Planエージェントを再起動して修正 |
| .claude/docs配下へのコピーに失敗 | ディレクトリの存在確認、ファイル名の重複確認 |

## 関連スキル

- [quality_check](../quality_check/SKILL.md): 実装完了後の品質チェック
- [skill_creator](../skill_creator/SKILL.md): スキル定義の生成・管理

## 詳細ドキュメント

詳細は [SKILL.md](./SKILL.md) を参照してください。
