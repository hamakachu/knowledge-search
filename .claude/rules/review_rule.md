# コードレビュールール

## 基本原則

実装完了後、**必ずレビュー専用サブエージェントによるレビューを実施する。**

---

## レビュープロセス

### 1. レビュータスクの記録（メインエージェント）

レビュー依頼前に、`.claude/docs/dashboard.md` の「メインエージェント → サブエージェント」セクションに以下を記載:
- タスクステータス: レビュー依頼中
- 対象ファイル: レビュー対象のファイルパス
- 変更内容: 実装内容のサマリー
- 追加指示: 特別な注意点

### 2. レビューサブエージェントの起動

メインエージェントが実装完了後、Task toolで `.claude/agents/` 配下のレビューエージェントを呼び出す。

**命名規則**: `xxx_reviewer.md`
- 例: `code_reviewer.md`, `typescript_reviewer.md`

### 3. dashboard.mdの確認（サブエージェント）

サブエージェントは起動時に `.claude/docs/dashboard.md` を読み取り、レビュー対象と指示内容を確認する。

### 4. レビュー実行項目

レビューサブエージェントは以下を実施:

#### 必須チェック項目
- ✅ テスト実行（`pnpm test`）
- ✅ テストカバレッジ確認
- ✅ Lintチェック（`pnpm lint`）
- ✅ 型チェック（`pnpm typecheck`）
- ✅ ビルド確認（`pnpm build`）

#### コード品質評価
- **保守性**: コードの可読性、拡張性、保守しやすさ
- **安全性**: セキュリティ脆弱性、エラーハンドリング
- **パフォーマンス**: 非効率なコード、N+1クエリ等

### 5. レビュー結果のdashboard.md記載（サブエージェント）

レビュー完了後、`.claude/docs/dashboard.md` の「サブエージェント → メインエージェント」セクションに結果を記載:
- レビュー結果ステータス: 完了
- 実行結果: テスト・Lint・型チェック・ビルドの結果
- 問題点: 発見した問題のリスト
- 推奨事項: 改善提案

### 6. レビュー結果の返却形式（参考）

```markdown
## コードレビュー結果

### テスト実行結果
- ✅ / ❌ すべてのテストがパス
- テストカバレッジ: XX%

### Lint/型チェック
- ✅ / ❌ ESLint
- ✅ / ❌ TypeScript型チェック

### ビルド
- ✅ / ❌ ビルド成功

### コード品質評価
- 保守性: [評価と根拠]
- 安全性: [評価と根拠]
- パフォーマンス: [評価と根拠]

### 改善提案
- [具体的な改善点をリストアップ]
```

### 7. dashboard.mdの確認と対応（メインエージェント）

メインエージェントは `.claude/docs/dashboard.md` の「サブエージェント → メインエージェント」セクションを確認:
1. ❌ 問題があれば修正を行う
2. ✅ すべてのチェックがパスしたら、ユーザーに報告して承認を求める
3. 完了後、履歴に記録して現在のタスクセクションをクリア

---

## ユーザー承認フロー

すべてのレビューチェックがパスした後、以下の形式でユーザーに承認を求める:

```
以下の変更を実装しました:
- [変更内容のサマリー]

コードレビュー結果:
- ✅ すべてのテストがパス
- ✅ Lint/型チェック完了
- ✅ ビルド成功
- ✅ コード品質評価完了

この変更を反映してよろしいですか？
```

---

## まとめ

| フェーズ | 担当 | 必須アクション |
|---------|------|--------------|
| **実装** | メインエージェント | テストをパスする実装 |
| **レビュー依頼** | メインエージェント | dashboard.mdにタスク指示を記載 |
| **タスク確認** | レビューサブエージェント | dashboard.mdから指示を読み取り |
| **レビュー実行** | レビューサブエージェント | テスト・Lint・型チェック・ビルド・品質評価 |
| **結果記載** | レビューサブエージェント | dashboard.mdに結果を記載 |
| **結果確認** | メインエージェント | dashboard.mdから結果を読み取り |
| **修正 or 承認** | メインエージェント | 問題があれば修正、なければユーザーに承認を求める |
| **履歴記録** | メインエージェント | dashboard.mdの履歴に記録し、セクションをクリア |
| **反映** | メインエージェント | 承認後に変更を反映 |

**すべての実装工程でこのレビュープロセスを遵守すること。**
